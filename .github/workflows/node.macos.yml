name: Node.js CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  release:
    types: [ prereleased ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js 14.x
      uses: actions/setup-node@v1
      with:
        node-version: 14.x
    - uses: actions/cache@v2
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - run: npm install
    - run: npm run electron:build
    - run: echo ::set-output name=filename::$(ls dist_electron/*.dmg)
      name: Determinate package name
      id: pkgname
    - uses: actions/upload-artifact@master
      with:
        name: CoronaLauncher-${{ github.sha }}.macOS.dmg
        path: ${{ steps.pkgname.outputs.filename }}
    - name: Create Release Artifact
      uses: svenstaro/upload-release-action@v1-release
      if: github.event_name == 'release'
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ${{ steps.pkgname.outputs.filename }}
        asset_name: macOS.dmg
        tag: ${{ github.ref }}
        overwrite: true
